#!/usr/bin/env node 
/*
 * resteasy -- A rest API testing suite
 * 	test - Run the tests
 */
var fs = require("fs"),
	exec = require('child_process').exec,
	argv = require("optimist").argv;

// Global for the test files
global.resteasy = require("../cli/interface.js");

switch(argv._[0]) {
	case "test":
		var filename = argv._[1];

		if(filename) {
			try {
				if(argv.report) display("report");
				if(argv.simple) display("fail", "begin", "pass", "info", "report");

				// Import the tests
				var file = require(process.cwd() + "/" + filename);

				//Perform an selections
				if(argv.i !== undefined) {
					argv.i = argv.i.toString();
					if(/(\d+)\.\.(\d+)/.exec(argv.i)) resteasy.begin([RegExp.$1, RegExp.$2]);
					else resteasy.begin(argv._.slice(2).concat([argv.i.replace(",", "")]));
				} else {
					resteasy.begin();
				}
			} catch(e) {
				if(e.code == "MODULE_NOT_FOUND") oops("Can't find test file.");
				else throw e;
			}
		} else {
			oops("Please supply a test file.");
		}
	break;

	case "help":
	default:
		help();
}

function display() {
	for(var key in resteasy.options.display) resteasy.options.display[key] = Array.prototype.indexOf.call(arguments, key) !== -1;
}

function oops(message) {
	console.log(("Error: " + message).red.inverse);
	process.exit();
}

function help() {
	[
		"resteasy -- Simple REST API testing",
		"  help \t\t Shows this help.",
		"  test <file> \t Run a test file.",
		"    --simple  \t Simple output report",
		"    --report  \t Just output report",
		"    -i x..y   \t Run tests numbers x through to y",
		"    -i x, y, z\t Run tests x, y, z only",
		"  doc  \t\t Output API documentation (coming soon)"
	].forEach(function(line) {
		console.log(line);
	});
}